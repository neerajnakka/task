name: CD - Terraform Deploy

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker Image Tag to Deploy (default: latest commit SHA from CI)'
        required: true
        type: string

jobs:
  terraform-deploy:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ap-south-1

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      working-directory: ./task5-terraform
      run: terraform init

    - name: Terraform Validate
      working-directory: ./task5-terraform
      run: terraform validate

    - name: Terraform Apply
      id: tf-apply
      working-directory: ./task5-terraform
      run: |
        terraform apply -auto-approve
        echo "public_ip=$(terraform output -raw instance_public_ip)" >> $GITHUB_OUTPUT

    - name: Deploy to EC2 via SSH
      uses: appleboy/ssh-action@v1.0.3
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ap-south-1
        ECR_REPOSITORY: neeraj-strapi-repo
      with:
        host: ${{ steps.tf-apply.outputs.public_ip }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        envs: AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_REGION,ECR_REPOSITORY
        script: |
          # Wait for cloud-init (User Data) to finish
          echo "Waiting for cloud-init to complete..."
          cloud-init status --wait > /dev/null

          # Export creds for this session
          export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
          export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
          export AWS_DEFAULT_REGION=$AWS_REGION

          # Install AWS CLI v2 (more robust than apt)
          sudo apt-get update
          sudo apt-get install -y unzip curl
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -o awscliv2.zip
          sudo ./aws/install --update

          # Get Account ID to construct ECR URL
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URL="${ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"
          REPO_URL="${ECR_URL}/${ECR_REPOSITORY}"

          # Login to ECR (Docker needs sudo)
          aws ecr get-login-password --region $AWS_DEFAULT_REGION | sudo docker login --username AWS --password-stdin $ECR_URL
          
          # Pull new image
          IMAGE_URI="${REPO_URL}:${{ inputs.image_tag }}"
          sudo docker pull $IMAGE_URI
          
          # Stop and Remove existing container
          sudo docker stop strapi-app || true
          sudo docker rm strapi-app || true
          
          # Ensure network exists (Docker Compose usually creates 'foldername_networkname')
          NETWORK_NAME="strapi-app_strapi-net"
          if ! sudo docker network inspect "$NETWORK_NAME" >/dev/null 2>&1; then
            echo "Network $NETWORK_NAME not found, creating..."
            sudo docker network create "$NETWORK_NAME"
          fi

          # Run new container
          sudo docker run -d \
            --name strapi-app \
            --restart always \
            -p 80:1337 \
            -e DATABASE_CLIENT=postgres \
            -e DATABASE_HOST=postgres-container-strapi \
            -e DATABASE_PORT=5432 \
            -e DATABASE_NAME=strapidb \
            -e DATABASE_USERNAME=strapi \
            -e DATABASE_PASSWORD=strapi123 \
            -e NODE_ENV=production \
            -e APP_KEYS="key1,key2" \
            -e API_TOKEN_SALT="somerandomsalt123" \
            -e ADMIN_JWT_SECRET="supersecretadminjwt" \
            -e JWT_SECRET="supersecretjwt" \
            --network "$NETWORK_NAME" \
            $IMAGE_URI
